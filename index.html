<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Charlene's Bloom Planner</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Bloom Planner">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f0f7fd">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=DM+Sans:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f7fd;
  --bg2: #f5faff;
  --surface: #ffffff;
  --surface2: #e8f3fb;
  --border: #cfe4f5;
  --border2: #b8d6ef;
  --text: #1a2d3d;
  --text2: #3b5c78;
  --muted: #6a9ab8;
  --muted2: #96bdd4;
  --rose: #4a9eca;
  --rose-dim: rgba(74,158,202,0.12);
  --rose-soft: #a8d4eb;
  --blush: #7bbfe0;
  --lavender: #89a8d4;
  --lavender-dim: rgba(137,168,212,0.15);
  --sage: #6ab8a8;
  --sage-dim: rgba(106,184,168,0.15);
  --gold: #5a8fc9;
  --gold-dim: rgba(90,143,201,0.12);
  --cream: #e2f0fb;
  --shadow: 0 2px 20px rgba(70,130,180,0.08);
  --shadow-md: 0 4px 32px rgba(70,130,180,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  padding-bottom: env(safe-area-inset-bottom);
  background-image:
    radial-gradient(ellipse at 0% 0%, rgba(74,158,202,0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 100% 100%, rgba(196,168,212,0.08) 0%, transparent 50%);
}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(253,246,240,0.92);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  padding-top: calc(16px + env(safe-area-inset-top));
  display: flex; align-items: center; justify-content: space-between;
}
.app-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 26px;
  font-weight: 400;
  font-style: italic;
  color: var(--rose);
  letter-spacing: 0.02em;
  line-height: 1;
}
.app-title span {
  font-style: normal;
  font-weight: 300;
  color: var(--muted);
  font-size: 14px;
  display: block;
  font-family: 'DM Sans', sans-serif;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  margin-top: 1px;
}
.today-badge {
  font-family: 'DM Sans', sans-serif;
  font-size: 11px;
  font-weight: 500;
  color: var(--muted);
  border: 1px solid var(--border2);
  background: var(--surface);
  padding: 5px 12px;
  border-radius: 20px;
  letter-spacing: 0.04em;
}

/* â”€â”€ DAY PILLS â”€â”€ */
.day-selector-wrap { padding: 20px 24px 0; }
.day-selector-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--muted2);
  margin-bottom: 10px;
}
.day-pills {
  display: flex; gap: 8px;
  overflow-x: auto; padding-bottom: 4px;
  margin-bottom: 18px; scrollbar-width: none;
}
.day-pills::-webkit-scrollbar { display: none; }
.day-pill {
  position: relative; cursor: pointer;
  border-radius: 16px; border: 1.5px solid var(--border);
  padding: 10px 14px; background: var(--surface);
  transition: all 0.25s; min-width: 70px; flex-shrink: 0;
  text-align: center; user-select: none;
  box-shadow: var(--shadow);
}
.day-pill:hover { border-color: var(--rose-soft); transform: translateY(-1px); box-shadow: var(--shadow-md); }
.day-pill.active { border-color: var(--rose); background: var(--rose-dim); }
.day-pill.active .pill-name { color: var(--rose); }
.day-pill.today-pill::after {
  content: ''; position: absolute; bottom: 5px; left: 50%;
  transform: translateX(-50%); width: 4px; height: 4px;
  border-radius: 50%; background: var(--rose);
}
.pill-name {
  font-family: 'Playfair Display', serif;
  font-size: 16px; font-weight: 400;
  color: var(--text); line-height: 1; margin-bottom: 2px;
}
.pill-date { font-size: 9px; color: var(--muted); margin-bottom: 2px; font-weight: 400; }
.pill-sub { font-size: 9px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted2); }
.pill-done-dot {
  position: absolute; top: 6px; right: 6px;
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--sage); display: none;
}
.day-pill.has-history .pill-done-dot { display: block; }

/* â”€â”€ SESSION BANNER â”€â”€ */
.session-banner {
  margin: 0 24px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 14px 18px;
  display: flex; align-items: flex-start;
  justify-content: space-between; gap: 12px;
  box-shadow: var(--shadow);
}
.session-banner-left { flex: 1; min-width: 0; }
.session-banner-label {
  font-size: 10px; font-weight: 600;
  letter-spacing: 0.18em; text-transform: uppercase;
  color: var(--muted2); margin-bottom: 4px;
}
.session-banner-time {
  font-family: 'Playfair Display', serif;
  font-size: 20px; color: var(--text); font-weight: 400;
}
.session-banner-time span { color: var(--rose); }
.no-session-set { color: var(--muted); font-size: 13px; }
.event-badge {
  display: inline-flex; align-items: center; gap: 5px;
  margin-top: 6px; margin-right: 4px;
  background: var(--lavender-dim);
  border: 1px solid rgba(196,168,212,0.4);
  border-radius: 20px; padding: 3px 10px;
  font-size: 11px; color: var(--lavender); font-weight: 500;
}
.edit-session-btn {
  background: var(--surface2);
  border: 1px solid var(--border2);
  color: var(--muted);
  font-family: 'DM Sans', sans-serif;
  font-size: 11px; font-weight: 600;
  letter-spacing: 0.06em; text-transform: uppercase;
  padding: 8px 14px; border-radius: 10px;
  cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0;
}
.edit-session-btn:hover { border-color: var(--rose); color: var(--rose); }

/* â”€â”€ PROGRESS â”€â”€ */
.progress-wrap { padding: 0 24px 16px; }
.progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.progress-label { font-size: 10px; font-weight: 600; letter-spacing: 0.18em; text-transform: uppercase; color: var(--muted2); }
.progress-count { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--rose); }
.progress-track { height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--rose), var(--blush)); border-radius: 3px; transition: width 0.6s cubic-bezier(0.34,1.56,0.64,1); width: 0%; }

/* â”€â”€ WATER â”€â”€ */
.water-card {
  margin: 0 24px 16px;
  background: var(--surface);
  border: 1px solid rgba(143,173,140,0.3);
  border-radius: 16px; padding: 14px 18px;
  box-shadow: var(--shadow);
}
.water-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.water-title { font-size: 10px; font-weight: 600; letter-spacing: 0.18em; text-transform: uppercase; color: var(--sage); }
.water-count-label { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--sage); }
.water-oz { font-size: 10px; color: var(--muted2); margin-top: 2px; }
.water-bottles { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
.bottle {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  cursor: pointer; user-select: none; transition: all 0.2s;
  padding: 7px 10px; border-radius: 12px;
  border: 1.5px solid var(--border); background: var(--bg2); min-width: 52px;
}
.bottle:hover { border-color: var(--sage); transform: translateY(-2px); }
.bottle.filled { border-color: var(--sage); background: var(--sage-dim); }
.bottle-icon { font-size: 20px; filter: grayscale(1) opacity(0.3); transition: filter 0.2s; }
.bottle.filled .bottle-icon { filter: none; }
.bottle-label { font-size: 9px; color: var(--muted2); font-weight: 500; }
.bottle.filled .bottle-label { color: var(--sage); }
.water-progress-track { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; margin-bottom: 8px; }
.water-progress-fill { height: 100%; background: var(--sage); border-radius: 2px; transition: width 0.4s ease; }
.water-note { font-size: 11px; color: var(--muted); }
.water-note span { color: var(--sage); font-weight: 600; }

/* â”€â”€ CONTENT â”€â”€ */
.content { padding: 0 24px 80px; display: grid; grid-template-columns: 1fr 280px; gap: 18px; align-items: start; }

/* â”€â”€ TASK CARDS â”€â”€ */
.task-list { display: flex; flex-direction: column; gap: 8px; }
.task-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px; padding: 14px 16px;
  display: flex; align-items: flex-start; gap: 12px;
  cursor: pointer; transition: all 0.25s;
  animation: riseIn 0.4s ease both;
  position: relative; overflow: hidden;
  box-shadow: var(--shadow);
}
.task-card::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0;
  width: 3px; background: var(--card-color, var(--border));
  opacity: 0; transition: opacity 0.2s; border-radius: 3px 0 0 3px;
}
.task-card:hover { border-color: var(--border2); transform: translateY(-1px); box-shadow: var(--shadow-md); }
.task-card:hover::before, .task-card.done::before { opacity: 1; }
.task-card.done { opacity: 0.5; }
.task-card.done .task-label { text-decoration: line-through; color: var(--muted2); }
.task-card.done::before { background: var(--sage) !important; }
.task-card.event-task { border-color: rgba(196,168,212,0.4); background: var(--lavender-dim); }
.task-card.anchor-task { border-color: rgba(74,158,202,0.25); }
.task-check {
  width: 22px; height: 22px; border-radius: 50%;
  border: 1.5px solid var(--border2); flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  margin-top: 1px; transition: all 0.2s; font-size: 11px;
  background: var(--bg);
}
.task-card.done .task-check { background: var(--sage); border-color: var(--sage); color: white; }
.task-body { flex: 1; min-width: 0; }
.task-top { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 3px; }
.task-time { font-size: 10px; font-weight: 600; letter-spacing: 0.1em; color: var(--muted2); text-transform: uppercase; }
.task-duration {
  font-size: 10px; color: var(--muted);
  background: var(--bg2); padding: 2px 8px;
  border-radius: 10px; white-space: nowrap;
  border: 1px solid var(--border);
}
.task-label { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 2px; }
.task-note { font-size: 11px; color: var(--muted); font-weight: 300; line-height: 1.4; }
.task-tag {
  font-size: 10px; font-weight: 600; letter-spacing: 0.06em;
  text-transform: uppercase; padding: 2px 8px; border-radius: 20px;
  margin-top: 6px; display: inline-block;
}
.anchor-badge {
  font-size: 9px; font-weight: 600; letter-spacing: 0.1em;
  text-transform: uppercase; padding: 1px 7px; border-radius: 10px;
  background: var(--rose-dim); color: var(--rose); margin-left: 6px; vertical-align: middle;
}
@keyframes riseIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.task-card:nth-child(1){animation-delay:.03s}.task-card:nth-child(2){animation-delay:.06s}.task-card:nth-child(3){animation-delay:.09s}.task-card:nth-child(4){animation-delay:.12s}.task-card:nth-child(5){animation-delay:.15s}.task-card:nth-child(6){animation-delay:.18s}.task-card:nth-child(7){animation-delay:.21s}.task-card:nth-child(8){animation-delay:.24s}.task-card:nth-child(9){animation-delay:.27s}.task-card:nth-child(10){animation-delay:.30s}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar { display: flex; flex-direction: column; gap: 14px; }
.sidebar-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px; padding: 18px 20px;
  box-shadow: var(--shadow);
}
.sidebar-card h3 {
  font-size: 10px; font-weight: 600;
  letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--muted2); margin-bottom: 14px;
}
.streak-display { display: flex; align-items: baseline; gap: 6px; margin-bottom: 5px; }
.streak-num { font-family: 'Cormorant Garamond', serif; font-size: 52px; color: var(--rose); line-height: 1; font-weight: 400; }
.streak-unit { font-size: 13px; color: var(--muted2); }
.streak-sub { font-size: 11px; color: var(--muted); line-height: 1.6; font-style: italic; font-family: 'Cormorant Garamond', serif; font-size: 14px; }
.week-dots { display: flex; gap: 5px; margin-top: 12px; }
.w-dot {
  flex: 1; aspect-ratio: 1; border-radius: 8px;
  background: var(--border); display: flex; align-items: center;
  justify-content: center; font-size: 9px; font-weight: 600; color: var(--muted2);
}
.w-dot.partial { background: var(--rose-dim); color: var(--rose); }
.w-dot.full { background: var(--sage); color: white; }
.w-dot.today-dot { outline: 2px solid var(--rose); outline-offset: 2px; }
.heatmap { display: flex; flex-direction: column; gap: 8px; }
.heatmap-row { display: flex; align-items: center; gap: 8px; }
.heatmap-day-label { font-size: 11px; color: var(--muted2); width: 28px; flex-shrink: 0; font-weight: 500; }
.heatmap-bar-wrap { flex: 1; height: 16px; background: var(--border); border-radius: 8px; overflow: hidden; }
.heatmap-bar { height: 100%; border-radius: 8px; transition: width 0.7s cubic-bezier(0.34,1.2,0.64,1); }
.heatmap-pct { font-size: 10px; color: var(--muted2); width: 28px; text-align: right; flex-shrink: 0; }
.log-list { display: flex; flex-direction: column; gap: 5px; max-height: 180px; overflow-y: auto; }
.log-list::-webkit-scrollbar { width: 3px; }
.log-list::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
.log-item { display: flex; justify-content: space-between; align-items: center; gap: 7px; padding: 7px 10px; background: var(--bg2); border-radius: 10px; }
.log-item-left { display: flex; align-items: center; gap: 8px; }
.log-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.log-text { font-size: 11px; color: var(--text); font-weight: 500; }
.log-meta { font-size: 10px; color: var(--muted2); }
.log-pct { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: var(--border); color: var(--muted2); flex-shrink: 0; }
.log-pct.good { background: var(--sage-dim); color: var(--sage); }
.log-pct.great { background: var(--rose-dim); color: var(--rose); }
.empty-state { text-align: center; padding: 28px 12px; color: var(--muted); font-size: 12px; line-height: 1.8; }
.empty-state .big { font-size: 28px; margin-bottom: 8px; }
.reset-btn {
  display: block; width: 100%; margin-top: 10px; padding: 8px;
  background: transparent; border: 1px solid var(--border);
  border-radius: 10px; color: var(--muted2);
  font-family: 'DM Sans', sans-serif; font-size: 11px; font-weight: 600;
  letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.2s;
}
.reset-btn:hover { border-color: #4a9eca55; color: var(--rose); }

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(45,31,26,0.5); backdrop-filter: blur(10px);
  z-index: 200; display: flex; align-items: flex-start;
  justify-content: center; padding: 20px;
  opacity: 0; pointer-events: none; transition: opacity 0.25s; overflow-y: auto;
}
.modal-overlay.show { opacity: 1; pointer-events: all; }
.modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 24px; padding: 28px 24px;
  width: 100%; max-width: 420px;
  transform: translateY(16px); transition: transform 0.3s cubic-bezier(0.34,1.4,0.64,1);
  margin: auto; box-shadow: var(--shadow-md);
}
.modal-overlay.show .modal { transform: translateY(0); }
.modal h2 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 30px; font-weight: 400; font-style: italic;
  color: var(--rose); margin-bottom: 4px;
}
.modal-sub { font-size: 12px; color: var(--muted); margin-bottom: 22px; line-height: 1.6; }
.modal-field { margin-bottom: 16px; }
.modal-field label {
  display: block; font-size: 10px; font-weight: 600;
  letter-spacing: 0.16em; text-transform: uppercase;
  color: var(--muted2); margin-bottom: 8px;
}
.time-select, .text-input {
  width: 100%; background: var(--bg2); border: 1.5px solid var(--border);
  color: var(--text); font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 400; padding: 10px 14px;
  border-radius: 12px; transition: border-color 0.2s; appearance: none;
}
.time-select:focus, .text-input:focus { outline: none; border-color: var(--rose); }
.text-input::placeholder { color: var(--muted2); }
.event-time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.day-off-row { display: flex; align-items: center; gap: 10px; }
.divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
.event-section-title {
  font-size: 10px; font-weight: 600; letter-spacing: 0.18em;
  text-transform: uppercase; color: var(--lavender);
  margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
}
.event-section-title::after { content: ''; flex: 1; height: 1px; background: rgba(196,168,212,0.3); }
.events-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; max-height: 160px; overflow-y: auto; }
.event-item {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--lavender-dim); border: 1px solid rgba(196,168,212,0.3);
  border-radius: 10px; padding: 8px 12px; gap: 8px;
}
.event-item-text { font-size: 12px; color: var(--text); font-weight: 500; flex: 1; }
.event-item-time { font-size: 10px; color: var(--lavender); }
.event-delete { background: none; border: none; color: var(--muted2); cursor: pointer; font-size: 14px; transition: color 0.15s; }
.event-delete:hover { color: var(--rose); }
.add-event-btn {
  width: 100%; padding: 10px; background: var(--lavender-dim);
  border: 1.5px dashed rgba(196,168,212,0.5); border-radius: 12px;
  color: var(--lavender); font-family: 'DM Sans', sans-serif;
  font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;
}
.add-event-btn:hover { background: rgba(196,168,212,0.2); border-style: solid; }

/* Workout type toggle */
.workout-toggle { display: flex; gap: 6px; }
.workout-opt {
  flex: 1; padding: 9px 6px; text-align: center; border-radius: 10px;
  border: 1.5px solid var(--border); background: var(--bg2);
  color: var(--muted2); font-family: 'DM Sans', sans-serif;
  font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.15s;
}
.workout-opt.selected { border-color: var(--sage); background: var(--sage-dim); color: var(--sage); }

.modal-btn {
  width: 100%; padding: 14px;
  background: linear-gradient(135deg, var(--rose), var(--blush));
  border: none; border-radius: 14px; color: white;
  font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600;
  letter-spacing: 0.04em; cursor: pointer; margin-top: 22px; transition: opacity 0.2s;
  box-shadow: 0 4px 20px rgba(74,158,202,0.3);
}
.modal-btn:hover { opacity: 0.9; }
.modal-cancel { display: block; text-align: center; margin-top: 12px; color: var(--muted2); font-size: 12px; cursor: pointer; }
.modal-cancel:hover { color: var(--rose); }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--text); color: var(--bg);
  padding: 11px 20px; border-radius: 14px;
  font-size: 13px; font-weight: 500; z-index: 999;
  transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
  pointer-events: none; white-space: nowrap; max-width: 90vw;
  box-shadow: var(--shadow-md);
}
.toast.show { transform: translateX(-50%) translateY(0); }

@media(max-width:700px) { .content { grid-template-columns: 1fr; } .sidebar { display: grid; grid-template-columns: 1fr 1fr; } }
@media(max-width:480px) { .sidebar { grid-template-columns: 1fr; } .water-bottles { gap: 5px; } .bottle { min-width: 44px; } }
</style>
</head>
<body>

<div class="topbar">
  <div class="app-title">
    Charlene's Bloom
    <span>Daily Planner</span>
  </div>
  <div class="today-badge" id="real-date">...</div>
</div>

<div class="day-selector-wrap">
  <div class="day-selector-label">Next 7 Days</div>
  <div class="day-pills" id="day-pills"></div>
</div>

<div class="session-banner">
  <div class="session-banner-left">
    <div class="session-banner-label" id="banner-label">Today's Schedule</div>
    <div class="session-banner-time" id="session-display"><span class="no-session-set">Tap to set your day âœ¨</span></div>
    <div id="event-display"></div>
  </div>
  <button class="edit-session-btn" onclick="openSessionModal()">âœ¦ Set Day</button>
</div>

<div class="progress-wrap">
  <div class="progress-header">
    <div class="progress-label">Today's Progress</div>
    <div class="progress-count" id="progress-count">â€” / â€”</div>
  </div>
  <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
</div>

<div class="water-card">
  <div class="water-header">
    <div class="water-title">ğŸ’§ Hydration</div>
    <div class="water-right" style="display:flex;align-items:center;gap:10px;">
      <div>
        <div class="water-count-label" id="water-count">0 / 8</div>
        <div class="water-oz" id="water-oz">0 / 67.6 oz</div>
      </div>
    </div>
  </div>
  <div class="water-progress-track"><div class="water-progress-fill" id="water-progress-fill"></div></div>
  <div class="water-bottles" id="water-bottles"></div>
  <div class="water-note">Goal: <span>8 glasses daily</span> â€” glowing skin starts with hydration ğŸŒ¿</div>
</div>

<div class="content">
  <div class="task-list" id="task-list"></div>
  <div class="sidebar">
    <div class="sidebar-card">
      <h3>ğŸŒ¸ Streak</h3>
      <div class="streak-display"><div class="streak-num" id="streak-num">0</div><div class="streak-unit">days</div></div>
      <div class="streak-sub" id="streak-sub">Start your streak today.</div>
      <div class="week-dots" id="week-dots"></div>
    </div>
    <div class="sidebar-card">
      <h3>ğŸŒ· This Week</h3>
      <div class="heatmap" id="heatmap"></div>
    </div>
    <div class="sidebar-card">
      <h3>ğŸ“– History</h3>
      <div class="log-list" id="log-list"></div>
      <button class="reset-btn" onclick="confirmReset()">â†º Reset All Data</button>
    </div>
  </div>
</div>

<!-- SESSION MODAL -->
<div class="modal-overlay" id="session-modal">
  <div class="modal">
    <h2>Plan Your Day</h2>
    <p class="modal-sub">Set tutoring hours if you have a session, or mark it a free study day. Bible study is always first ğŸŒ¸</p>

    <div class="modal-field">
      <label>Day</label>
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:10px 14px;font-family:'Playfair Display',serif;font-size:18px;color:var(--rose);" id="modal-day-display">â€”</div>
    </div>

    <div class="modal-field">
      <label>Day Type</label>
      <div style="display:flex;gap:6px;">
        <div class="workout-opt selected" id="dtype-study" onclick="selectDayType('study')" style="border-color:var(--rose);background:var(--rose-dim);color:var(--rose);">ğŸ“š Study Day</div>
        <div class="workout-opt" id="dtype-tutor" onclick="selectDayType('tutor')">ğŸ‘©â€ğŸ« Tutoring</div>
        <div class="workout-opt" id="dtype-rest" onclick="selectDayType('rest')">ğŸŒ¿ Rest Day</div>
      </div>
    </div>

    <div id="tutor-time-fields" style="display:none;">
      <div class="modal-field">
        <label>Tutoring Start</label>
        <select class="time-select" id="tutor-start"></select>
      </div>
      <div class="modal-field">
        <label>Tutoring End</label>
        <select class="time-select" id="tutor-end"></select>
      </div>
    </div>

    <div class="modal-field">
      <label>Workout Today</label>
      <div class="workout-toggle">
        <div class="workout-opt selected" id="wtype-gym" onclick="selectWorkoutType('gym')">ğŸ’ª Gym</div>
        <div class="workout-opt" id="wtype-cardio" onclick="selectWorkoutType('cardio')">ğŸƒ Cardio</div>
        <div class="workout-opt" id="wtype-walk" onclick="selectWorkoutType('walk')">ğŸš¶ Walk</div>
        <div class="workout-opt" id="wtype-rest" onclick="selectWorkoutType('rest')">ğŸ›Œ Skip</div>
      </div>
    </div>

    <hr class="divider">
    <div class="event-section-title">Special Events</div>
    <div class="events-list" id="events-list"></div>

    <div id="add-event-form" style="display:none;background:var(--bg2);border:1px solid rgba(196,168,212,0.3);border-radius:12px;padding:14px;margin-bottom:10px;">
      <div class="modal-field" style="margin-bottom:10px;">
        <label>Event Name</label>
        <input type="text" class="text-input" id="event-name" placeholder="e.g. Doctor's appt, Dinner with friendsâ€¦">
      </div>
      <div class="modal-field" style="margin-bottom:10px;">
        <label>Start â†’ End Time</label>
        <div class="event-time-row">
          <select class="time-select" id="event-start" style="font-size:13px;padding:8px 10px;"></select>
          <select class="time-select" id="event-end" style="font-size:13px;padding:8px 10px;"></select>
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="addEvent()" style="flex:1;padding:9px;background:var(--lavender);border:none;border-radius:10px;color:white;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;">Add âœ¦</button>
        <button onclick="document.getElementById('add-event-form').style.display='none'" style="padding:9px 14px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--muted2);font-family:'DM Sans',sans-serif;font-size:12px;cursor:pointer;">Cancel</button>
      </div>
    </div>

    <button class="add-event-btn" onclick="toggleEventForm()">âœ¦ Add Special Event</button>
    <button class="modal-btn" onclick="saveSession()">Build My Day âœ¨</button>
    <span class="modal-cancel" onclick="closeSessionModal()">Cancel</span>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONSTANTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BOTTLE_OZ  = 8.45;   // standard glass ~250ml
const BOTTLE_GOAL = 8;     // 8 glasses
const SK = 'charlenes_bloom_v1';

const TAG = {
  bible:   { color:'#4a9eca', bg:'rgba(74,158,202,0.12)', label:'Faith' },
  study:   { color:'#c084fc', bg:'rgba(192,132,252,0.12)', label:'Study' },
  tutor:   { color:'#60a5fa', bg:'rgba(96,165,250,0.12)',  label:'Tutoring' },
  gym:     { color:'#8fad8c', bg:'rgba(143,173,140,0.15)', label:'Gym' },
  cardio:  { color:'#2dd4bf', bg:'rgba(45,212,191,0.12)',  label:'Cardio' },
  walk:    { color:'#a3c4a0', bg:'rgba(163,196,160,0.15)', label:'Walk' },
  food:    { color:'#c9935a', bg:'rgba(201,147,90,0.1)',   label:'Nutrition' },
  glow:    { color:'#4a9eca', bg:'rgba(74,158,202,0.08)', label:'Self Care' },
  free:    { color:'#6a9ab8', bg:'rgba(106,154,184,0.08)', label:'Rest' },
  event:   { color:'#c4a8d4', bg:'rgba(196,168,212,0.15)', label:'Event' },
  prep:    { color:'#c9935a', bg:'rgba(201,147,90,0.08)',  label:'Prep' },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TIME UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtTime(mins) {
  const h = Math.floor(mins / 60) % 24, m = mins % 60;
  const ap = h >= 12 ? 'PM' : 'AM', h12 = h % 12 || 12;
  return `${h12}:${m.toString().padStart(2,'0')} ${ap}`;
}
function fmtDur(mins) {
  const h = Math.floor(mins / 60), m = mins % 60;
  if (h === 0) return `${m} min`;
  if (m === 0) return `${h} hr${h > 1 ? 's' : ''}`;
  return `${h} hr ${m} min`;
}
function parseTime(str) {
  if (!str) return 0;
  const [time, ap] = str.split(' ');
  let [h, m] = time.split(':').map(Number);
  if (ap === 'PM' && h !== 12) h += 12;
  if (ap === 'AM' && h === 12) h = 0;
  return h * 60 + m;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATE UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayStr() { return localDateStr(new Date()); }
function localDateStr(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function get7Days() {
  const days = [];
  const base = new Date(); base.setHours(0,0,0,0);
  for (let i = 0; i < 7; i++) {
    const d = new Date(base); d.setDate(base.getDate() + i);
    days.push({
      dateStr: localDateStr(d),
      dayName: d.toLocaleDateString('en-US', {weekday:'short'}),
      dateLabel: d.toLocaleDateString('en-US', {month:'short', day:'numeric'}),
      isToday: i === 0,
    });
  }
  return days;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// shifts  = { "YYYY-MM-DD": { dayType, tutorStart, tutorEnd, workoutType, events:[] } }
// history = { "YYYY-MM-DD": { done:[], total:0, water:0 } }
// dayType: 'study' | 'tutor' | 'rest'
// workoutType: 'gym' | 'cardio' | 'walk' | 'rest'
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = { activeDate: todayStr(), shifts: {}, history: {} };

function loadState() {
  try {
    const s = JSON.parse(localStorage.getItem(SK));
    if (s) { state.shifts = s.shifts || {}; state.history = s.history || {}; }
  } catch(e) {}
}
function saveState() {
  try { localStorage.setItem(SK, JSON.stringify({ shifts: state.shifts, history: state.history })); }
  catch(e) {}
}
function getShift(d)  { return state.shifts[d]  || null; }
function getSess(d)   { return state.history[d] || null; }
function ensureSess(d) {
  const shift = getShift(d);
  const tasks = shift ? buildSchedule(shift, d) : [];
  if (!state.history[d]) state.history[d] = { done: [], total: tasks.length, water: 0 };
  state.history[d].total = tasks.length;
  return state.history[d];
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCHEDULE BUILDER
//
// Wake times (sleep midnight â†’ 8hrs rest):
//   Rest day      â†’ 9:00 AM
//   Study day     â†’ 8:00 AM
//   Tutoring AM   â†’ 7:30 AM
//   Tutoring PM+  â†’ 8:00 AM
//
// Fixed order:
//   Bible Study (1hr) â†’ Shower+Dress (30min) â†’ Breakfast â†’ [Workout] â†’ [Study/Tutor blocks] â†’ Meals â†’ Skincare â†’ Sleep
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isWeekend(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  const day = d.getDay();
  return day === 0 || day === 6;
}

function buildSchedule(shift, dateStr) {
  const { dayType = 'study', tutorStart, tutorEnd, workoutType = 'gym', events = [] } = shift;

  const tutorStartMin = (dayType === 'tutor' && tutorStart) ? parseTime(tutorStart) : null;
  const tutorEndMin   = (dayType === 'tutor' && tutorEnd)   ? parseTime(tutorEnd)   : null;

  // Wake time: weekend=10am, weekday=8am, early-tutor-weekday=7am. Sleep=10pm.
  const weekend = dateStr ? isWeekend(dateStr) : false;
  let wakeTime;
  if (weekend)                                             wakeTime = 10 * 60;
  else if (dayType === 'tutor' && tutorStartMin < 10*60)  wakeTime = 7 * 60;
  else                                                     wakeTime = 8 * 60;

  const SLEEP_TIME = 22 * 60;

  const tasks = [];
  let cursor = wakeTime;

  // place() â€” puts task at cursor, advances cursor by dur+5
  function place(dur, label, note, tag, isAnchor = false) {
    tasks.push({ time: cursor, dur, label, note, tag, isAnchor, isEvent: false });
    cursor += dur + 5;
  }

  // pin() â€” puts task at exact time (or cursor if cursor is later), advances cursor
  function pin(time, dur, label, note, tag, isAnchor = false) {
    const actualTime = Math.max(time, cursor);
    tasks.push({ time: actualTime, dur, label, note, tag, isAnchor, isEvent: false });
    cursor = actualTime + dur + 5;
  }

  // ANCHOR: Bible Study â€” 1 hour, always first
  place(60, 'ğŸ“– Bible Study', 'One hour with the Word â€” anchor the day in faith.', 'bible', true);

  // Morning routine
  place(15, 'ğŸš¿ Shower',      'Refresh and reset', 'glow');
  place(15, 'ğŸ‘— Get Dressed', 'Put your best self forward', 'glow');
  place(30, 'ğŸ³ Breakfast',   'High protein, balanced â€” eating to fuel not restrict', 'food');

  // Workout
  if      (workoutType === 'gym')    place(75, 'ğŸ’ª Gym',    'Drive + 1 hr lift â€” consistency is everything', 'gym');
  else if (workoutType === 'cardio') place(45, 'ğŸƒ Cardio', 'Run, bike, or dance â€” move your body', 'cardio');
  else if (workoutType === 'walk')   place(35, 'ğŸš¶ Walk',   'Fresh air + steps â€” counts more than you think', 'walk');

  if (dayType === 'rest') {
    place(120, 'ğŸ“š Study Block',    '2 hr flexible study â€” no pressure, stay consistent', 'study');
    place(30,  'ğŸ¥— Lunch',          'Light, balanced, satisfying', 'food');
    place(90,  'ğŸŒ¿ Free Time',      'Read, friends, watch something, recharge fully', 'free');
    place(30,  'ğŸ½ï¸ Dinner',        'Balanced plate â€” protein, veg, complex carbs', 'food');
    place(15,  'ğŸŒ™ Skincare',       'Night routine â€” cleanse, tone, moisturise, glow', 'glow');
    place(20,  'ğŸ—“ï¸ Plan Tomorrow', "Review tomorrow's schedule, set intentions", 'prep');

  } else if (dayType === 'study') {
    place(90,  'ğŸ“š Study Block 1',  'Deep focus â€” hardest subject first while brain is fresh', 'study');
    place(30,  'ğŸ¥— Lunch',          "Step away, eat properly, don't skip this", 'food');
    place(90,  'ğŸ“š Study Block 2',  'Second session â€” review, practice problems, notes', 'study');
    place(30,  'â˜• Break',           'Stretch, water, 10 min walk if possible', 'free');
    place(60,  'ğŸ“š Study Block 3',  'Final push â€” wrap up, review what you learned today', 'study');
    place(30,  'ğŸ½ï¸ Dinner',        'Balanced plate â€” protein, veg, complex carbs', 'food');
    place(15,  'ğŸŒ™ Skincare',       'Night routine â€” cleanse, tone, moisturise, glow', 'glow');
    place(20,  'ğŸ—“ï¸ Plan Tomorrow', "Set tomorrow's schedule", 'prep');

  } else {
    // TUTORING DAY
    if (tutorStartMin !== null) {
      const travelTime = tutorStartMin - 15;
      const morningGap = travelTime - cursor;
      if (morningGap >= 60) {
        place(Math.min(morningGap - 20, 90), 'ğŸ“š Morning Study', 'Study block before your session', 'study');
      }
      // Lunch 45min before travel if space, else right now
      const idealLunch = travelTime - 45;
      if (idealLunch > cursor + 10) {
        pin(idealLunch, 30, 'ğŸ¥— Lunch', "Eat before your session â€” don't work on empty", 'food');
      } else {
        place(30, 'ğŸ¥— Lunch', "Eat before your session â€” don't work on empty", 'food');
      }
      // Pin travel block â€” pin() uses Math.max so these never overlap
      pin(travelTime,    15,                       'ğŸš— Travel to Session', '15 min drive', 'prep');
      pin(tutorStartMin, tutorEndMin-tutorStartMin, 'ğŸ‘©â€ğŸ« Tutoring Session',
        fmtTime(tutorStartMin) + ' â€“ ' + fmtTime(tutorEndMin) + " â€” you're the expert, own it",
        'tutor', true);
      pin(tutorEndMin,   15,                       'ğŸš— Travel Home', '15 min drive', 'prep');
    }
    // Post-tutor study if time allows before sleep
    const remaining = SLEEP_TIME - cursor - 30 - 15 - 20 - 15;
    if (remaining >= 45) {
      place(Math.min(remaining, 90), 'ğŸ“š Study Block', 'Post-session study â€” momentum is on your side', 'study');
    }
    place(30, 'ğŸ½ï¸ Dinner',        'Balanced plate â€” you earned it today', 'food');
    place(15, 'ğŸŒ™ Skincare',       'Night routine â€” cleanse, tone, moisturise, glow', 'glow');
    place(20, 'ğŸ—“ï¸ Plan Tomorrow', "Review and set tomorrow's intentions", 'prep');
  }

  if (events.length > 0) return resolveWithEvents(tasks, events);
  tasks.sort((a, b) => a.time - b.time);
  return tasks.map(t => ({...t, timeStr: fmtTime(t.time), durStr: fmtDur(t.dur)}));
}

function resolveWithEvents(baseTasks, events) {
  const eventBlocks = events.map(ev => {
    const st = parseTime(ev.start), en = parseTime(ev.end);
    const dur = en > st ? en - st : 60;
    return { time: st, dur, end: st + dur,
      label: `ğŸ—“ï¸ ${ev.name}`, note: `${ev.start} â€“ ${ev.end}`,
      tag: 'event', isEvent: true, isAnchor: false };
  }).sort((a, b) => a.time - b.time);

  const IMMOVABLE = (t) => t.tag === 'tutor' || t.tag === 'bible' || (t.tag === 'prep' && t.label.includes('Travel'));

  let resolved = baseTasks.map(task => {
    if (IMMOVABLE(task)) return task;
    let t = {...task};
    for (let i = 0; i < 30; i++) {
      const clash = eventBlocks.find(ev => t.time < ev.end && (t.time + t.dur) > ev.time);
      if (!clash) break;
      t = {...t, time: clash.end + 10};
    }
    return t;
  });

  resolved.sort((a, b) => a.time - b.time);
  for (let i = 1; i < resolved.length; i++) {
    if (IMMOVABLE(resolved[i])) continue;
    const prevEnd = resolved[i-1].time + resolved[i-1].dur;
    if (resolved[i].time < prevEnd) resolved[i] = {...resolved[i], time: prevEnd + 5};
  }

  const all = [...resolved, ...eventBlocks];
  all.sort((a, b) => a.time - b.time);
  return all.map(t => ({...t, timeStr: fmtTime(t.time), durStr: fmtDur(t.dur)}));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MODAL STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let modalDate = null;
let pendingEvents = [];
let pendingWorkoutType = 'gym';
let pendingDayType = 'study';

function generateTimeOptions() {
  const t = [];
  for (let h = 5; h <= 23; h++) for (let m of [0, 30]) {
    const ap = h >= 12 ? 'PM' : 'AM', h12 = h % 12 || 12;
    t.push(`${h12}:${m.toString().padStart(2,'0')} ${ap}`);
  }
  return t;
}
function populateTimeSelect(id, val) {
  const el = document.getElementById(id);
  el.innerHTML = generateTimeOptions().map(t => `<option value="${t}">${t}</option>`).join('');
  if (val) el.value = val;
}

function openSessionModal() {
  modalDate = state.activeDate;
  const dayInfo = get7Days().find(d => d.dateStr === modalDate);
  document.getElementById('modal-day-display').textContent =
    dayInfo ? `${dayInfo.dayName}, ${dayInfo.dateLabel}` : modalDate;

  populateTimeSelect('tutor-start', '10:00 AM');
  populateTimeSelect('tutor-end',   '12:00 PM');
  populateTimeSelect('event-start', '10:00 AM');
  populateTimeSelect('event-end',   '11:00 AM');

  const ex = getShift(modalDate);
  if (ex) {
    pendingDayType     = ex.dayType     || 'study';
    pendingWorkoutType = ex.workoutType || 'gym';
    pendingEvents      = [...(ex.events || [])];
    if (ex.tutorStart) document.getElementById('tutor-start').value = ex.tutorStart;
    if (ex.tutorEnd)   document.getElementById('tutor-end').value   = ex.tutorEnd;
  } else {
    pendingDayType     = 'study';
    pendingWorkoutType = 'gym';
    pendingEvents      = [];
  }

  selectDayType(pendingDayType);
  selectWorkoutType(pendingWorkoutType);
  renderModalEvents();
  document.getElementById('add-event-form').style.display = 'none';
  document.getElementById('event-name').value = '';
  document.getElementById('session-modal').classList.add('show');
}

function selectDayType(type) {
  pendingDayType = type;
  ['study','tutor','rest'].forEach(t => {
    const el = document.getElementById(`dtype-${t}`);
    // Clear all inline styles first so CSS class takes over cleanly
    el.style.borderColor = '';
    el.style.background  = '';
    el.style.color       = '';
    el.classList.remove('selected');
  });
  // Apply selected style to the chosen type
  const sel = document.getElementById(`dtype-${type}`);
  sel.classList.add('selected');
  if (type === 'study') {
    sel.style.borderColor = 'var(--rose)';
    sel.style.background  = 'var(--rose-dim)';
    sel.style.color       = 'var(--rose)';
  } else if (type === 'tutor') {
    sel.style.borderColor = 'var(--lavender)';
    sel.style.background  = 'var(--lavender-dim)';
    sel.style.color       = 'var(--lavender)';
  } else {
    sel.style.borderColor = 'var(--sage)';
    sel.style.background  = 'var(--sage-dim)';
    sel.style.color       = 'var(--sage)';
  }
  document.getElementById('tutor-time-fields').style.display = type === 'tutor' ? 'block' : 'none';
}

function selectWorkoutType(type) {
  pendingWorkoutType = type;
  ['gym','cardio','walk','rest'].forEach(t => {
    document.getElementById(`wtype-${t}`).classList.toggle('selected', t === type);
  });
}

function toggleEventForm() {
  const form = document.getElementById('add-event-form');
  const hidden = form.style.display === 'none' || !form.style.display;
  form.style.display = hidden ? 'block' : 'none';
  if (hidden) document.getElementById('event-name').focus();
}

function addEvent() {
  const name = document.getElementById('event-name').value.trim();
  if (!name) { showToast('Enter an event name âœ¨'); return; }
  const start = document.getElementById('event-start').value;
  const end   = document.getElementById('event-end').value;
  if (parseTime(start) >= parseTime(end)) { showToast('End time must be after start ğŸŒ¸'); return; }
  pendingEvents.push({ name, start, end });
  document.getElementById('event-name').value = '';
  document.getElementById('add-event-form').style.display = 'none';
  renderModalEvents();
  showToast(`âœ¦ "${name}" added`);
}

function removeEvent(i) { pendingEvents.splice(i, 1); renderModalEvents(); }

function renderModalEvents() {
  const el = document.getElementById('events-list');
  if (!pendingEvents.length) {
    el.innerHTML = `<div style="font-size:11px;color:var(--muted2);text-align:center;padding:10px;font-style:italic;">No special events yet</div>`;
    return;
  }
  el.innerHTML = pendingEvents.map((ev, i) => `
    <div class="event-item">
      <div>
        <div class="event-item-text">${ev.name}</div>
        <div class="event-item-time">${ev.start} â€“ ${ev.end}</div>
      </div>
      <button class="event-delete" onclick="removeEvent(${i})">âœ•</button>
    </div>
  `).join('');
}

function closeSessionModal() { document.getElementById('session-modal').classList.remove('show'); }

function saveSession() {
  if (pendingDayType === 'tutor') {
    const s = document.getElementById('tutor-start').value;
    const e = document.getElementById('tutor-end').value;
    if (parseTime(s) >= parseTime(e)) { showToast('Tutoring end must be after start ğŸŒ¸'); return; }
    state.shifts[modalDate] = { dayType: 'tutor', tutorStart: s, tutorEnd: e, workoutType: pendingWorkoutType, events: [...pendingEvents] };
  } else {
    state.shifts[modalDate] = { dayType: pendingDayType, workoutType: pendingWorkoutType, events: [...pendingEvents] };
  }
  delete state.history[modalDate];
  saveState(); closeSessionModal(); renderAll();
  const wt = { gym:'ğŸ’ª', cardio:'ğŸƒ', walk:'ğŸš¶', rest:'ğŸ›Œ' }[pendingWorkoutType] || '';
  const typeLabel = { study:'Study day', tutor:'Tutoring day', rest:'Rest day' }[pendingDayType];
  showToast(`${typeLabel} set ${wt} âœ¨`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() { renderPills(); renderBanner(); renderTasks(); renderWater(); renderSidebar(); }

function renderPills() {
  const days = get7Days();
  document.getElementById('day-pills').innerHTML = days.map(d => {
    const sess  = getSess(d.dateStr);
    const shift = getShift(d.dateStr);
    const isActive = d.dateStr === state.activeDate;
    const pct = sess && sess.total > 0 ? Math.round(sess.done.length / sess.total * 100) : 0;
    let sub = 'â€”';
    if (sess && sess.done.length > 0) sub = pct + '%';
    else if (shift) sub = { study:'Study', tutor:'Tutor', rest:'Rest' }[shift.dayType] || 'â€”';
    return `<div class="day-pill ${isActive?'active':''} ${sess&&sess.done.length>0?'has-history':''} ${d.isToday?'today-pill':''}"
      onclick="selectDay('${d.dateStr}')">
      <div class="pill-done-dot"></div>
      <div class="pill-name">${d.dayName}</div>
      <div class="pill-date">${d.dateLabel}</div>
      <div class="pill-sub">${sub}</div>
    </div>`;
  }).join('');
}

function renderBanner() {
  const shift = getShift(state.activeDate);
  const el    = document.getElementById('session-display');
  const evEl  = document.getElementById('event-display');
  const btn   = document.querySelector('.edit-session-btn');
  const dayInfo = get7Days().find(d => d.dateStr === state.activeDate);
  document.getElementById('banner-label').textContent = dayInfo ? `${dayInfo.dayName}'s Schedule` : 'Schedule';

  if (!shift) {
    el.innerHTML = `<span class="no-session-set">Tap to set your day âœ¨</span>`;
    btn.textContent = 'âœ¦ Set Day';
    evEl.innerHTML = '';
  } else {
    const typeMap = { study:'ğŸ“š Study Day', tutor:'ğŸ‘©â€ğŸ« Tutoring', rest:'ğŸŒ¿ Rest Day' };
    const wtMap   = { gym:'ğŸ’ª Gym', cardio:'ğŸƒ Cardio', walk:'ğŸš¶ Walk', rest:'ğŸ›Œ Rest' };
    const label   = typeMap[shift.dayType] || 'ğŸ“š Study Day';
    const wt      = wtMap[shift.workoutType] || '';
    el.innerHTML  = `<span>${label}</span>`;
    btn.textContent = 'âœ¦ Edit';
    const badges = [
      wt ? `<span class="event-badge" style="background:var(--sage-dim);border-color:rgba(143,173,140,0.4);color:var(--sage)">${wt}</span>` : '',
      ...(shift.events||[]).map(ev => `<span class="event-badge">ğŸ—“ï¸ ${ev.name} Â· ${ev.start}</span>`),
      shift.dayType === 'tutor' ? `<span class="event-badge" style="background:rgba(96,165,250,0.1);border-color:rgba(96,165,250,0.3);color:#60a5fa">${shift.tutorStart} â€“ ${shift.tutorEnd}</span>` : ''
    ].filter(Boolean).join('');
    evEl.innerHTML = badges;
  }
}

function renderTasks() {
  const shift = getShift(state.activeDate);
  const container = document.getElementById('task-list');
  if (!shift) {
    container.innerHTML = `<div class="empty-state"><div class="big">ğŸŒ¸</div>Nothing planned yet.<br><strong style="color:var(--rose)">Tap "Set Day"</strong> to build your schedule.<br><br><span style="color:var(--muted2);font-size:11px">Tip: set tomorrow the night before ğŸŒ™</span></div>`;
    document.getElementById('progress-count').textContent = 'â€” / â€”';
    document.getElementById('progress-fill').style.width = '0%';
    return;
  }
  const tasks = buildSchedule(shift, state.activeDate);
  const sess  = ensureSess(state.activeDate);
  container.innerHTML = tasks.map((t, i) => {
    const done = sess.done.includes(i);
    const tag  = TAG[t.tag] || TAG.free;
    const anchorBadge = t.isAnchor && t.tag === 'bible' ? `<span class="anchor-badge">Anchor</span>` : '';
    return `<div class="task-card ${done?'done':''} ${t.isEvent?'event-task':''} ${t.isAnchor&&!t.isEvent?'anchor-task':''}"
      style="--card-color:${tag.color}" onclick="toggleTask(${i})">
      <div class="task-check">${done?'âœ“':''}</div>
      <div class="task-body">
        <div class="task-top">
          <div class="task-time">${t.timeStr}</div>
          <div class="task-duration">${t.durStr}</div>
        </div>
        <div class="task-label">${t.label}${anchorBadge}</div>
        <div class="task-note">${t.note}</div>
        <span class="task-tag" style="color:${tag.color};background:${tag.bg}">${tag.label}</span>
      </div>
    </div>`;
  }).join('');
  renderProgress(sess, tasks.length);
}

function renderProgress(sess, total) {
  const done = sess ? sess.done.length : 0;
  const pct  = total > 0 ? Math.round(done / total * 100) : 0;
  document.getElementById('progress-count').textContent = `${done} / ${total}`;
  document.getElementById('progress-fill').style.width  = pct + '%';
}

function renderWater() {
  const sess    = getSess(state.activeDate) || { water: 0 };
  const glasses = sess.water || 0;
  const ozDone  = (glasses * BOTTLE_OZ).toFixed(0);
  const ozTotal = (BOTTLE_GOAL * BOTTLE_OZ).toFixed(0);
  const pct     = Math.round(glasses / BOTTLE_GOAL * 100);
  document.getElementById('water-count').textContent = `${glasses} / ${BOTTLE_GOAL}`;
  document.getElementById('water-oz').textContent    = `${ozDone} / ${ozTotal} oz`;
  document.getElementById('water-progress-fill').style.width = pct + '%';
  document.getElementById('water-bottles').innerHTML = Array.from({length: BOTTLE_GOAL}, (_, i) => `
    <div class="bottle ${i < glasses ? 'filled' : ''}" onclick="tapWater(${i})">
      <div class="bottle-icon">ğŸ¥›</div>
      <div class="bottle-label">glass</div>
    </div>
  `).join('');
}

function renderSidebar() {
  const days = get7Days();
  const allDates = Object.entries(state.history)
    .filter(([k,v]) => v.done.length > 0).map(([k]) => k).sort();

  let streak = 0;
  const d = new Date();
  for (let i = 0; i < 365; i++) {
    const ds = localDateStr(d);
    if (allDates.includes(ds)) { streak++; d.setDate(d.getDate()-1); }
    else if (i === 0) { d.setDate(d.getDate()-1); }
    else break;
  }
  document.getElementById('streak-num').textContent = streak;
  document.getElementById('streak-sub').textContent =
    streak === 0 ? 'Start your streak today, sis.' :
    streak === 1 ? 'Day one. You showed up.' :
    streak < 7   ? `${streak} days. You\'re building something real.` :
    `${streak} days. This is your season.`;

  document.getElementById('week-dots').innerHTML = days.map(d => {
    const s   = getSess(d.dateStr);
    const pct = s && s.total > 0 ? s.done.length / s.total : 0;
    const cls = pct === 0 ? '' : pct >= 1 ? 'full' : 'partial';
    return `<div class="w-dot ${cls} ${d.isToday?'today-dot':''}">${d.dayName.charAt(0)}</div>`;
  }).join('');

  document.getElementById('heatmap').innerHTML = days.map(d => {
    const s   = getSess(d.dateStr);
    const pct = s && s.total > 0 ? s.done.length / s.total : 0;
    const color = pct === 0 ? 'var(--border)' : pct < 0.5 ? 'var(--blush)' : pct < 1 ? 'var(--rose-soft)' : 'var(--sage)';
    return `<div class="heatmap-row">
      <div class="heatmap-day-label">${d.dayName}</div>
      <div class="heatmap-bar-wrap"><div class="heatmap-bar" style="width:${Math.round(pct*100)}%;background:${color}"></div></div>
      <div class="heatmap-pct">${s && s.total > 0 ? Math.round(pct*100)+'%' : 'â€”'}</div>
    </div>`;
  }).join('');

  const entries = Object.entries(state.history)
    .filter(([k,v]) => v.done.length > 0)
    .sort(([a],[b]) => b.localeCompare(a)).slice(0, 20);
  const logEl = document.getElementById('log-list');
  if (!entries.length) {
    logEl.innerHTML = `<div class="empty-state"><div class="big">ğŸŒ¸</div>No history yet.<br>Complete tasks to see your progress.</div>`;
    return;
  }
  logEl.innerHTML = entries.map(([date, val]) => {
    const pct = val.total > 0 ? Math.round(val.done.length / val.total * 100) : 0;
    const pc  = pct >= 100 ? 'great' : pct >= 50 ? 'good' : '';
    const dc  = pct >= 100 ? 'var(--sage)' : pct >= 50 ? 'var(--rose)' : 'var(--blush)';
    const ds  = new Date(date+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',weekday:'short'});
    const sh  = state.shifts[date];
    const sl  = sh ? ({study:'Study',tutor:'Tutor',rest:'Rest'}[sh.dayType]||'') : '';
    return `<div class="log-item">
      <div class="log-item-left">
        <div class="log-dot" style="background:${dc}"></div>
        <div><div class="log-text">${ds}</div><div class="log-meta">${sl}</div></div>
      </div>
      <div class="log-pct ${pc}">${pct}%</div>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectDay(dateStr) { state.activeDate = dateStr; renderAll(); }

function toggleTask(i) {
  const sess  = ensureSess(state.activeDate);
  const shift = getShift(state.activeDate);
  if (sess.done.includes(i)) { sess.done = sess.done.filter(x => x !== i); }
  else {
    sess.done.push(i);
    const tasks = shift ? buildSchedule(shift, d) : [];
    if (sess.done.length === tasks.length && tasks.length > 0) showToast('ğŸŒ¸ Day complete! You did that.');
  }
  saveState(); renderTasks(); renderPills(); renderSidebar();
}

function tapWater(i) {
  const sess = ensureSess(state.activeDate);
  sess.water = (sess.water || 0) === i + 1 ? i : i + 1;
  if (sess.water === BOTTLE_GOAL) showToast('ğŸ’§ Hydration goal hit! Skin is glowing ğŸŒ¿');
  saveState(); renderWater();
}

function confirmReset() {
  if (confirm('Reset all data? This cannot be undone.')) {
    state.history = {}; state.shifts = {};
    saveState(); renderAll(); showToast('All data cleared ğŸŒ¸');
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  document.getElementById('real-date').textContent =
    new Date().toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
  loadState(); renderAll();
  if ('serviceWorker' in navigator)
    window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js').catch(() => {}));
}
init();
</script>
</body>
</html>
